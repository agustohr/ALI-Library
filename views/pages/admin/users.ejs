<!doctype html>
<html lang="en">
  <head>
    <%- include('partials_admin/head'); %>
    <title>ALI Library - Users</title>
  </head>
  <body id="page-top">
    <!-- Page Wrapper -->
    <div id="wrapper">

      <%- include('partials_admin/sidebar'); %>

      <!-- Content Wrapper -->
      <div id="content-wrapper" class="d-flex flex-column">

          <!-- Main Content -->
          <div id="content">

            <%- include('partials_admin/topbar'); %>

              <!-- Begin Page Content -->
              <div class="container-fluid">

                  <!-- Page Heading -->
                  <h1 class="h3 mb-2 text-gray-800">Tabel Users</h1>
                  <p class="mb-4">Users / pengguna yang sudah registrasi</p>

                  <!-- DataTales Example -->
                  <div class="card shadow mb-4">
                      <div class="card-header py-3">
                          <h6 class="m-0 font-weight-bold text-primary">Data Users</h6>
                      </div>
                      <div class="card-body">
                          <div class="table-responsive">
                            <button type="button" class="btn btn-success btn-lg my-2" data-bs-toggle="modal" data-bs-target="#regisUser">
                              <i class="fa-solid fa-plus"></i> Register User
                            </button>
                              <table class="table table-striped" id="dataTable" width="100%" cellspacing="0">
                                <thead>
                                  <tr>
                                      <th>ID Pegawai</th>
                                      <th>Nama</th>
                                      <th>Jabatan</th>
                                      <th>Gender</th>
                                      <th>Phone</th>
                                      <th>Email</th>
                                      <th>Ration</th>
                                      <th>Status</th>
                                      <th>Action</th>
                                  </tr>
                              </thead>
                              <tfoot>
                                  <tr>
                                      <th>ID Pegawai</th>
                                      <th>Nama</th>
                                      <th>Jabatan</th>
                                      <th>Gender</th>
                                      <th>Phone</th>
                                      <th>Email</th>
                                      <th>Ration</th>
                                      <th>Status</th>
                                      <th>Action</th>
                                  </tr>
                              </tfoot>
                              <tbody>
                                  <% user.forEach((i,index)=> { %>
                                    <% if (i.role == "member") { %>
                                        <tr>
                                            <td><%= i.id_pegawai%></td>
                                            <td><%= i.nama%></td>
                                            <td><%= i.jabatan%></td>
                                            <td><%= i.gender%></td>
                                            <td><%= i.no_hp%></td>
                                            <td><%= i.email%></td>
                                            <td><%= i.ration%></td>
                                            <% if (i.status_users == "active") { %>
                                                <td><span class="badge text-bg-success"><%= i.status_users%></span></td>
                                            <% } else if(i.status_users == "notactive"){%>
                                                <td><span class="badge text-bg-danger"><%= i.status_users%></span></td>
                                                <% } %>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group" aria-label="Basic mixed styles example">
                                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editUser" data-bs-i="<%= i.id %>" data-bs-id="<%= i.id_pegawai %>" data-bs-nama="<%= i.nama %>" data-bs-jabatan="<%= i.jabatan %>" data-bs-gender="<%= i.gender %>" data-bs-phone="<%= i.no_hp %>" data-bs-email="<%= i.email %>">Edit</button>
                                                    <button type="button" class="btn btn-danger" onclick="deleteItem(<%=i.id%>)">Delete</button>
                                                </div>
                                                
                                            </td>
                                            </tr>
                                    <% } %>
                                      
                                  <% }) %>
                              </tbody>
                              </table>
                          </div>
                      </div>
                  </div>

              </div>
              <!-- /.container-fluid -->

          </div>
          <!-- End of Main Content -->

          <%- include('partials_admin/footer'); %>

      </div>
      <!-- End of Content Wrapper -->

  </div>
  <!-- End of Page Wrapper -->
  
    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
  </a>

  <%- include('partials_admin/logout'); %>

    <!-- ================================modal tambah item======================== -->
    <div class="modal fade" id="regisUser" tabindex="-1" aria-labelledby="regisUserLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="regisUserLabel">Register User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="id_pegawai" class="col-form-label">ID Pegawai:</label>
                <input type="text" class="form-control" id="id_pegawai">
              </div>
              <div class="mb-3">
                <label for="nama" class="col-form-label">Nama:</label>
                <input type="text" class="form-control" id="nama">
              </div>
              <div class="mb-3">
                <label for="password" class="col-form-label">Password:</label>
                <input type="password" class="form-control" id="password">
              </div>
              <div class="mb-3">
                <label for="jabatan" class="col-form-label">Jabatan:</label>
                <input type="text" class="form-control" id="jabatan">
              </div>
              <div class="mb-3">
                <label for="statusAdd" class="col-form-label">Gender:</label><br>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="gender" id="male" value="male">
                    <label class="form-check-label" for="male">
                      Male
                    </label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="gender" id="female" value="female">
                    <label class="form-check-label" for="female">
                      Female
                    </label>
                  </div>
              </div>
              <div class="mb-3">
                <label for="phone" class="col-form-label">Phone:</label>
                <input type="text" class="form-control" id="phone">
              </div>
              <div class="mb-3">
                <label for="email" class="col-form-label">Email:</label>
                <input type="email" class="form-control" id="email">
              </div>
              <div class="mb-3">
                <label for="statusAdd" class="col-form-label">Status:</label><br>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="statusAdd" id="active" value="active">
                    <label class="form-check-label" for="active">
                      Active
                    </label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="statusAdd" id="notactive" value="notactive">
                    <label class="form-check-label" for="notactive">
                      Not Active
                    </label>
                  </div>
              </div>
              
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-success" onclick="tambahUser()">Register</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================modal edit user======================== -->
    <div class="modal fade" id="editUser" tabindex="-1" aria-labelledby="editUserLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editUserLabel">Edit User</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="index"></div>
            <div class="modal-body">
              <form id="detailBorrow">
                <div class="mb-3">
                  <label for="recipient-id" class="col-form-label">ID Pegawai:</label>
                  <input type="text" class="form-control" id="recipient-id">
                </div>
                <div class="mb-3">
                  <label for="recipient1-nama" class="col-form-label">Nama:</label>
                  <input type="text" class="form-control" id="recipient1-nama">
                </div>
                <div class="mb-3">
                  <label for="recipient2-jabatan" class="col-form-label">Jabatan:</label>
                  <input type="text" class="form-control" id="recipient2-jabatan">
                </div>
                <div class="mb-3">
                  <label for="recipient5-gender" class="col-form-label">Gender:</label>
                  <input type="text" class="form-control" id="recipient5-gender">
                </div>
                <div class="mb-3">
                  <label for="recipient3-phone" class="col-form-label">Phone:</label>
                  <input type="text" class="form-control" id="recipient3-phone">
                </div>
                <div class="mb-3">
                  <label for="recipient4-email" class="col-form-label">Email:</label>
                  <input type="text" class="form-control" id="recipient4-email">
                </div>
                <div class="mb-3">
                  <label for="user_status" class="col-form-label">Status:</label><br>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="user_status" id="active" value="active">
                      <label class="form-check-label" for="active">
                        Active
                      </label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="user_status" id="notactive" value="notactive">
                      <label class="form-check-label" for="notactive">
                        Not Active
                      </label>
                    </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="editUser()">Submit</button>
            </div>
          </div>
        </div>
      </div>
 
      <%- include('partials_admin/script'); %>
    <!-- script -->
    <script type="text/javascript">
      $(document).ready(function () {
          $('#dataTable').DataTable();
          // read();
      });

      async function read(){
        $.ajax({
          url: `/admin/tabelItem`,
          type: 'GET',
          success: function (result){
              // console.log($("#datatablesSimple").html(result).DataTable());
              $("#datatablesSimple").html(result).DataTable();
              // $('#datatablesSimple').DataTable(result);
          }
        })
      }


      /* Fungsi */
      // $('#editItem').on('show.bs.modal', function (event) {
      //   const button = $(event.relatedTarget) // Button that triggered the modal
      //   //const recipient = button.data('whatever') // Extract info from data-* attributes
      //   const id = button.data('bs-i')
      //   const recipient = button.data('bs-id')
      //   const recipient1 = button.data('bs-category')
      //   const recipient2 = button.data('bs-title')
      //   const recipient3 = button.data('bs-quantity')
      //   const recipient4 = button.data('bs-availableQuantity')
      //   // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
      //   // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
      //   const modal = $(this)
      //   modal.find('.modal-title').text('Edit ID Item ' + recipient)
      //   modal.find('#index').val(id)
      //   modal.find('#recipient-id').val(recipient)
      //   modal.find('#recipient1-category').val(recipient1)
      //   modal.find('#recipient2-title').val(recipient2)
      //   modal.find('#recipient3-quantity').val(recipient3)
      //   modal.find('#recipient4-availableQuantity').val(recipient4)
      // })

      const exampleModal = document.getElementById('editUser')
      exampleModal.addEventListener('show.bs.modal', event => {
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const id = button.getAttribute('data-bs-i')
        const recipient = button.getAttribute('data-bs-id')
        const recipient1 = button.getAttribute('data-bs-nama')
        const recipient2 = button.getAttribute('data-bs-jabatan')
        const recipient3 = button.getAttribute('data-bs-phone')
        const recipient4 = button.getAttribute('data-bs-email')
        const recipient5 = button.getAttribute('data-bs-gender')
        // const recipient3 = randomString(6)
        
        // If necessary, you could initiate an AJAX request here
        // and then do the updating in a callback.
        //
        // Update the modal's content.
        const modalTitle = exampleModal.querySelector('.modal-title')
        const index = exampleModal.querySelector('#index')
        const modalBodyInput = exampleModal.querySelector('#recipient-id')
        const modalBodyInput1 = exampleModal.querySelector('#recipient1-nama')
        const modalBodyInput2 = exampleModal.querySelector('#recipient2-jabatan')
        const modalBodyInput3 = exampleModal.querySelector('#recipient3-phone')
        const modalBodyInput4 = exampleModal.querySelector('#recipient4-email')
        const modalBodyInput5 = exampleModal.querySelector('#recipient5-gender')

        modalTitle.textContent = `Edit ID User ${recipient}`
        index.value = id
        modalBodyInput.value = recipient
        modalBodyInput1.value = recipient1
        modalBodyInput2.value = recipient2
        modalBodyInput3.value = recipient3
        modalBodyInput4.value = recipient4
        modalBodyInput5.value = recipient5
        
      })

      function deleteItem(id) {
        $.ajax({
            url: `http://localhost:8001/api/delete_users/${id}`,
            type: 'DELETE',
            success: function (result) {
              location.reload();
            }
        });
      }

      async function tambahUser() {
        let id_pegawai = $("#id_pegawai").val();
        let nama = $("#nama").val();
        let jabatan = $("#jabatan").val();
        let gender = $("input[name='gender']:checked").val();
        let phone = $("#phone").val();
        let email = $("#email").val();
        let userStatus = $("input[name='statusAdd']:checked").val();
        let role = "member"
        let password = $("#password").val();
        await fetch("http://localhost:8001/api/add_users", {
            method: 'post',
            body: `id_pegawai=${id_pegawai}&nama=${nama}&password=${password}&jabatan=${jabatan}&gender=${gender}&no_hp=${phone}&email=${email}&role=${role}&status_users=${userStatus}`,
            headers: 
            {
                "Content-Type": "application/x-www-form-urlencoded"
            }
        }).then(async (response) => {
            if (response.status === 400) {
              alert("Id Pegawai Tidak Boleh Kosong!")
            }
            if (response.status != 400) {
                // alert('Berhasil Tambah User Admin')
              location.reload();
            }
            return response.json()
        }).then((res) => {

        }).catch((error) => {
            console.log(error)
        })
        
      }

      async function editUser() {
        let i = $("#index").val();
        let id_pegawai = $("#recipient-id").val();
        let nama = $("#recipient1-nama").val();
        let jabatan = $("#recipient2-jabatan").val();
        let phone = $("#recipient3-phone").val();
        let email = $("#recipient4-email").val();
        let status_users = $("input[name='user_status']:checked").val();
        // let itemStatus = getSatus();
        // console.log(itemStatus)

        $.ajax({
            url: `http://localhost:8001/api/update_profile/${i}`,
            type: 'PUT',
            data: ({ id_pegawai: id_pegawai, nama: nama, jabatan: jabatan, no_hp: phone, email: email, status_users: status_users }),
            success: function (result) {
              // $("#datatablesSimple").html(result);
              // $(".btn-close").click();
              // read();
              // $(this).text(result);

              // $('#datatablesSimple').DataTable().ajax.url().load();
              // loadDoc();
              location.reload();
            }
        });

        // await fetch(`http://localhost:8001/api/update_item/${i}`, {
        //     method: 'put',
        //     body: `id_item=${id_item}&category=${category}&title=${title}&quantity=${quantity}&available_quantity=${availableQuantity}&items_status=${itemStatus}`,
        //     headers: 
        //     {
        //         "Content-Type": "application/x-www-form-urlencoded"
        //     }
        // }).then(async (response) => {
        //     if (response.status === 400) {
        //       alert("Id Item Tidak Boleh Kosong!")
        //     }
        //     if (response.status != 400) {
        //       location.reload();
        //     }
        //     return response.json()
        // }).then((res) => {

        // }).catch((error) => {
        //     console.log(error)
        // })
        
      }

      // function AutoRefresh( t ) {
      //     setTimeout("location.reload(true);", t);
      // }

      // function update() {
      //   $.get("http://localhost:8001/admin/item_admin", function(data) {
      //     $("#liveData").html(data);
      //     window.setTimeout(update, 1000);
      //   });
      // }
// ===========================================================================
    // no need to specify document ready
// $(function update(){
    
//     // optional: don't cache ajax to force the content to be fresh
//     $.ajaxSetup ({
//         cache: false
//     });
    

    
//     // specify the server/url you want to load data from
//     var url = "http://localhost:8001/api/get_all_item";
    
//     // on click, load the data dynamically into the #result div
//     load(url);
//     window.setTimeout(update, 1000);

//     // $("#liveData").click(function(){
//     //     $("#result").html(spinner).load(url);
//     // });

// });
// =====================================================================
// window.addEventListener('load', function()
// {
//     var xhr = null;

//     getXmlHttpRequestObject = function()
//     {
//         if(!xhr)
//         {               
//             // Create a new XMLHttpRequest object 
//             xhr = new XMLHttpRequest();
//         }
//         return xhr;
//     };

//     updateLiveData = function()
//     {
//         var now = new Date();
//         // Date string is appended as a query with live data 
//         // for not to use the cached version 
//         var url = 'http://localhost:8001/admin/item_admin' + now.getTime();
//         // var url = 'http://localhost:8001/api/get_all_item' + now.getTime();
//         xhr = getXmlHttpRequestObject();
//         xhr.onreadystatechange = evenHandler;
//         // asynchronous requests
//         xhr.open("GET", url, true);
//         // Send the request over the network
//         xhr.send(null);
//     };

//     updateLiveData();

//     function evenHandler()
//     {
//         // Check response is ready or not
//         if(xhr.readyState == 4 && xhr.status == 200)
//         {
//             dataDiv = document.getElementById('liveData');
//             // Set current data text
//             dataDiv.innerHTML = xhr.responseText;
//             // Update the live data every 1 sec
//             setTimeout(updateLiveData(), 1000);
//         }
//     }
// });

      // $(function update(){
        
      //   $.ajax({
      //     url:"http://localhost:8001/api/get_all_item",
      //     type: "GET",
      //     dataType: "JSON",
      //     success: function(data){
            
      //       // window.setTimeout(update, 1000);
      //       var nomor = 0;
      //       for(i=0; i<data.length; i++){
      //         nomor++;
      //         $('tbody').append('<tr><td>'+nomor+'</td><td>'+data[i].id_item+'</td><td>'+data[i].category+'</td><td>'+data[i].title+'</td><td>'+data[i].quantity+'</td><td>'+data[i].available_quantity+'</td><td>'+data[i].items_status+'</td><td>button</td></tr>');
      //       }
            
      //     },
      //     error: function(data){
      //       alert("Terjadi Kesalahan!");
      //     }
      //   });
      // });

    </script>
  </body>
</html>